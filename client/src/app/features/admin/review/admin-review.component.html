<ng-container *ngFor="let g of groups">
  <!-- Bloque informativo de empresa cedente -->
  <div class="cedente-block">
    <div class="cedente-label">Empresa cedente</div>
    <div class="cedente-value">
      {{ g.user?.companyName || "Desconocida" }}
      <span class="cedente-fiscal" *ngIf="g.user?.fiscalId">
        — {{ g.user?.fiscalId }}
      </span>
    </div>
  </div>

  <!-- Toolbar por grupo (filtros + acciones) -->
  <div class="search-label">Buscar por deudor</div>

  <div class="toolbar">
    <div class="filter-toolbar">
      <ath-input-text
        #searchRef
        name="search-debtor-bar"
        icon-position="left"
        type="search"
        placeholder="Escribe un nombre, DNI o razón social"
        [value]="g.searchQuery"
        (athClear)="onSearchClear(g, searchRef)"
        (keyup.enter)="applySearch(searchRef.value, g)"
        class="search-debtor-bar"
      ></ath-input-text>

      <ath-button
        color="secondary"
        size="md"
        fill="solid"
        (click)="applySearch(searchRef.value, g)"
        class="search-button"
      >
        Buscar
      </ath-button>

      <mat-select
        [(ngModel)]="g.selectedStatus"
        placeholder="Filtrar por estado"
        class="status-select"
        (selectionChange)="onStatusChange(g)"
      >
        <mat-option [value]="null">Todos</mat-option>
        <mat-option value="REVIEW">Pendiente</mat-option>
        <mat-option value="APPROVED">Validadas</mat-option>
        <mat-option value="REJECTED">Rechazadas</mat-option>
      </mat-select>
    </div>

    <span class="spacer"></span>

    <div class="buttons-toolbar">
      <!-- BOTÓN RECHAZAR -->
      <ath-button
        color="warn"
        size="md"
        fill="outlined"
        (click)="openAthModal(rechazarModal)"
        [disabled]="!hasSelectedRowsGroup(g)"
      >
        Rechazar
      </ath-button>

      <!-- MODAL RECHAZAR -->
      <ath-modal
        #rechazarModal
        has-close="true"
        has-divider="false"
        close-aria-label="Cerrar"
        (athClosed)="onModalClosed(g, 'rechazar')"
      >
        <div slot="body" class="modal-confirm">
          <ng-container [ngSwitch]="g.rechazarState">
            <div *ngSwitchCase="'confirm'">
              <div class="modal-icon">
                <img
                  src="../../../../assets/images/pictogram_notification.svg"
                  alt="Pictograma notificación"
                />
              </div>
              <h2 class="modal-title">
                {{
                  totalSelectedBills(g) === 1
                    ? "¿Desea cancelar el anticipo de la factura seleccionada?"
                    : "¿Desea cancelar el anticipo de las " +
                      totalSelectedBills(g) +
                      " facturas seleccionadas?"
                }}
              </h2>
            </div>

            <div *ngSwitchCase="'success'">
              <div class="modal-icon">
                <img
                  src="../../../../assets/images/pictogram_notification.svg"
                  alt="Pictograma notificación"
                />
              </div>
              <h2 class="modal-title modal-state-success">
                Anticipo rechazado
              </h2>
              <p class="modal-subtitle">
                El anticipo de las facturas seleccionadas se ha rechazado
                correctamente.
              </p>
            </div>

            <div *ngSwitchCase="'error'">
              <div class="modal-icon state-error"></div>
              <h2 class="modal-title modal-state-error">
                No se pudo rechazar el anticipo
              </h2>
              <p class="modal-subtitle">
                {{ g.rechazarResult?.completed || 0 }} rechazadas,
                {{ g.rechazarResult?.errors || 0 }} con error.
              </p>
            </div>
          </ng-container>
        </div>

        <div slot="footer" class="modal-actions">
          <ng-container [ngSwitch]="g.rechazarState">
            <ng-container *ngSwitchCase="'confirm'">
              <ath-button
                fill="outlined"
                color="secondary"
                class="btn-pill btn-outline"
                (click)="rechazarModal.closeModal()"
                aria-label="cancelar"
              >
                Cancelar
              </ath-button>
              <ath-button
                fill="solid"
                color="primary"
                class="btn-pill btn-primary"
                (click)="confirmRechazar(g, rechazarModal)"
                aria-label="rechazar-anticipo"
              >
                Rechazar
              </ath-button>
            </ng-container>
            <ng-container *ngSwitchDefault></ng-container>
          </ng-container>
        </div>
      </ath-modal>

      <!-- BOTÓN ANTICIPAR -->
      <ath-button
        color="primary"
        size="md"
        fill="solid"
        (click)="openAthModal(anticiparModal)"
        [disabled]="!hasSelectedRowsGroup(g)"
      >
        Anticipar
      </ath-button>

      <!-- MODAL ANTICIPAR -->
      <ath-modal
        #anticiparModal
        has-close="true"
        has-divider="false"
        close-aria-label="Cerrar"
        (athClosed)="onModalClosed(g, 'anticipar')"
      >
        <div slot="body" class="modal-confirm">
          <ng-container [ngSwitch]="g.anticiparState">
            <div *ngSwitchCase="'confirm'">
              <div class="modal-icon">
                <img
                  src="../../../../assets/images/pictogram_notification.svg"
                  alt="Pictograma notificación"
                />
              </div>
              <h2 class="modal-title">
                {{
                  totalSelectedBills(g) === 1
                    ? "La selección supera los parámetros de importe o vencimiento permitidos."
                    : "La selección de estas " +
                      totalSelectedBills(g) +
                      " facturas supera los parámetros de importe o vencimiento permitidos."
                }}
              </h2>
              <p class="modal-subtitle">¿Desea continuar?</p>
            </div>

            <div *ngSwitchCase="'success'">
              <div class="modal-icon">
                <img
                  src="../../../../assets/images/pictogram_notification.svg"
                  alt="Pictograma notificación"
                />
              </div>
              <h2 class="modal-title modal-state-success">
                Anticipo confirmado
              </h2>
              <p class="modal-subtitle">
                El anticipo de las facturas seleccionadas se ha realizado
                correctamente.
              </p>
            </div>

            <div *ngSwitchCase="'error'">
              <div class="modal-icon state-error"></div>
              <h2 class="modal-title modal-state-error">
                No se pudo completar el anticipo
              </h2>
              <p class="modal-subtitle">
                {{ g.anticiparResult?.completed || 0 }} confirmada(s),
                {{ g.anticiparResult?.errors || 0 }} con error.
              </p>
            </div>
          </ng-container>
        </div>

        <div slot="footer" class="modal-actions">
          <ng-container [ngSwitch]="g.anticiparState">
            <ng-container *ngSwitchCase="'confirm'">
              <ath-button
                fill="outlined"
                color="secondary"
                class="btn-pill btn-outline"
                (click)="anticiparModal.closeModal()"
                aria-label="cancelar"
              >
                Cancelar
              </ath-button>
              <ath-button
                fill="solid"
                color="primary"
                class="btn-pill btn-primary"
                (click)="confirmAnticipar(g, anticiparModal)"
                aria-label="anticipar"
              >
                Anticipar
              </ath-button>
            </ng-container>
            <ng-container *ngSwitchDefault></ng-container>
          </ng-container>
        </div>
      </ath-modal>
    </div>
  </div>

  <!-- Tabla por grupo -->
  <mat-card class="list-card" *ngIf="!loading; else loadingTpl">
    <div class="table-wrap">
      <div class="header-row">
        <div class="col-expand">
          <input
            type="checkbox"
            class="n-chk"
            [checked]="isAllCurrentPageSelectedGroup(g)"
            [indeterminate]="isCurrentPageIndeterminateGroup(g)"
            (change)="
              toggleSelectAllCurrentPageGroup(g, $any($event.target).checked)
            "
            aria-label="Seleccionar todo"
          />
        </div>

        <div class="col-status">
          <div
            class="cell cell-status cell-sortable"
            (click)="onSortGroup(g, 'status')"
          >
            <span>Estado</span>
            <mat-icon class="sort-icon">
              {{ getSortIconGroup(g, "status") }}
            </mat-icon>
          </div>
        </div>

        <div class="col-debtor">
          <div
            class="cell cell-debtor cell-sortable"
            (click)="onSortGroup(g, 'debtor')"
          >
            <span>Deudor</span>
            <mat-icon class="sort-icon">
              {{ getSortIconGroup(g, "debtor") }}
            </mat-icon>
          </div>
        </div>

        <div class="col-invoice">
          <div
            class="cell cell-invoice cell-sortable"
            (click)="onSortGroup(g, 'invoice')"
          >
            <span>Ref. Factura</span>
            <mat-icon class="sort-icon">
              {{ getSortIconGroup(g, "invoice") }}
            </mat-icon>
          </div>
        </div>

        <div class="col-amount">
          <div
            class="cell cell-amount cell-sortable"
            (click)="onSortGroup(g, 'amount')"
          >
            <span>Importe</span>
            <mat-icon class="sort-icon">
              {{ getSortIconGroup(g, "amount") }}
            </mat-icon>
          </div>
        </div>

        <div class="col-issue-date">
          <div
            class="cell cell-issue-date cell-sortable"
            (click)="onSortGroup(g, 'issueDate')"
          >
            <span>Fecha expedición</span>
            <mat-icon class="sort-icon">
              {{ getSortIconGroup(g, "issueDate") }}
            </mat-icon>
          </div>
        </div>

        <div class="col-due-date">
          <div
            class="cell cell-due-date cell-sortable"
            (click)="onSortGroup(g, 'dueDate')"
          >
            <span>Fecha vencimiento</span>
            <mat-icon class="sort-icon">
              {{ getSortIconGroup(g, "dueDate") }}
            </mat-icon>
          </div>
        </div>

        <div class="col-actions">
          <div class="cell cell-actions">Acciones</div>
        </div>
      </div>

      <ng-container *ngFor="let r of g.paginated">
        <div class="data-row">
          <div class="col-expand">
            <input
              type="checkbox"
              class="n-chk"
              [checked]="r.selected || !canSelectRow(r)"
              [disabled]="!canSelectRow(r)"
              (change)="
                r.selected = $any($event.target).checked; onCheckboxChange(r)
              "
              aria-label="Seleccionar fila"
            />
          </div>

          <div class="col-status">
            <div class="cell cell-status">
              <mat-chip [ngClass]="statusClass(r.status)">
                {{ statusLabel(r.status) }}
              </mat-chip>
            </div>
          </div>

          <div class="col-debtor">
            <div class="cell cell-debtor">{{ getFirstBillDebtor(r) }}</div>
          </div>

          <div class="col-invoice">
            <div class="cell cell-invoice">{{ getFirstInvoiceNumber(r) }}</div>
          </div>

          <div class="col-amount">
            <div class="cell cell-amount">{{ getFirstBillAmount(r) }}</div>
          </div>

          <div class="col-issue-date">
            <div class="cell cell-issue-date">{{ getFirstIssueDate(r) }}</div>
          </div>

          <div class="col-due-date">
            <div class="cell cell-due-date">{{ getFirstDueDate(r) }}</div>
          </div>

          <div class="col-actions">
            <div class="cell cell-actions">
              <ath-button
                color="secondary"
                size="xs"
                fill="outlined"
                (click)="openBillDetail(r)"
              >
                Ver factura
              </ath-button>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- FOOTER -->
    <div class="list-footer">
      <div class="selection-actions">
        <div class="selection-info">
          <ath-alert type="page" color="info" has-close="false">
            Has seleccionado {{ getTotalSelectedCountGroup(g) }} solicitud{{
              getTotalSelectedCountGroup(g) === 1 ? "" : "es"
            }}
          </ath-alert>
        </div>
        <div class="delete-selection">
          <ath-link defaultSlot="Link" (click)="clearAllSelectionsGroup(g)"
            >Borrar selección</ath-link
          >
        </div>
      </div>
      <!-- <mat-paginator
        [length]="g.filtered.length"
        [pageSize]="g.pageSize"
        [pageSizeOptions]="[5, 10]"
        [pageIndex]="g.pageIndex"
        (page)="onPageChangeGroup(g, $event)"
        showFirstLastButtons
      ></mat-paginator> -->
      <ath-pagination
        [totalItems]="g.filtered.length"
        [itemsPerPage]="g.pageSize"
        [currentPage]="g.pageIndex + 1"
        [noEndButtons]="false"
        [noJumpButtons]="false"
        [noItemsCount]="false"
        [noItemsSelector]="false"
        [itemsSelector]="'[5, 10]'"
        [athAriaLabel]="'Paginación de resultados'"
        (athPaginate)="onAthPaginateGroup(g, $event.detail)"
        (athItemsPerPageChange)="onAthItemsPerPageChangeGroup(g, $event.detail)"
      ></ath-pagination>
    </div>
  </mat-card>

  <ath-modal
    id="billDetailModal"
    has-close="true"
    has-divider="false"
    close-aria-label="Cerrar"
    (athClosed)="onBillDetailClosed()"
  >
    <div slot="body" class="bill-detail-modal">
      <h2 class="bill-detail-title">Detalle de factura</h2>

      <div class="bill-detail-grid" *ngIf="billDetail as b">
        <div class="bd-row">
          <div class="bd-label">Deudor</div>
          <div class="bd-value bd-strong">
            {{ b.debtor?.companyName || "Desconocido" }}
          </div>
        </div>

        <div class="bd-row">
          <div class="bd-label">Importe</div>
          <div class="bd-value bd-strong">
            {{
              b.amount
                ? (b.amount | currency: "EUR" : "symbol" : "1.2-2")
                : "0 €"
            }}
          </div>
        </div>

        <div class="bd-row bd-row--last-left">
          <div class="bd-label">Fecha de vencimiento</div>
          <div class="bd-value bd-strong">
            {{ b.dueDate ? (b.dueDate | date: "dd/MM/yyyy") : "—" }}
          </div>
        </div>

        <!-- Columna derecha -->
        <div class="bd-row">
          <div class="bd-label">Nº de factura</div>
          <div class="bd-value bd-strong">{{ b.invoiceNumber || "—" }}</div>
        </div>

        <div class="bd-row">
          <div class="bd-label">Fecha de expedición</div>
          <div class="bd-value bd-strong">
            {{ b.issueDate ? (b.issueDate | date: "dd/MM/yyyy") : "—" }}
          </div>
        </div>
      </div>

      <div class="bill-detail-empty" *ngIf="!billDetail">
        No hay información de factura para mostrar.
      </div>
    </div>
  </ath-modal>
</ng-container>

<ng-template #loadingTpl>
  <div style="padding: 24px">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  </div>
</ng-template>
