<h2>Solicitudes en revisión</h2>

<div class="toolbar">
  <span class="spacer"></span>
  <button
    mat-stroked-button
    color="primary"
    (click)="expandAll()"
    [disabled]="!hasRows()"
  >
    Expandir todo
  </button>
  <button mat-stroked-button (click)="collapseAll()" [disabled]="!hasRows()">
    Contraer todo
  </button>
</div>

<mat-card class="list-card" *ngIf="!loading; else loadingTpl">
  <div class="table-wrap">
    <!-- ===== HEADER (grid) ===== -->
    <div class="header-row">
      <div class="col-expand"></div>
      <div class="col-id"><div class="cell cell-id">ID solicitud</div></div>
      <div class="col-client"><div class="cell cell-client">Cliente</div></div>
      <div class="col-count">
        <div class="cell cell-count">Nº facturas</div>
      </div>
      <div class="col-total">
        <div class="cell cell-total">Total adeudado</div>
      </div>
      <div class="col-status"><div class="cell cell-status">Estado</div></div>
      <div class="col-actions">
        <div class="cell cell-actions">Acciones</div>
      </div>
    </div>

    <!-- ===== FILAS ===== -->
    <ng-container *ngFor="let r of rows">
      <!-- Fila principal -->
      <div class="data-row">
        <!-- Chevron -->
        <div class="col-expand">
          <button mat-icon-button (click)="toggleRow(r)">
            <mat-icon>{{
              isExpanded(r.id) ? "expand_less" : "expand_more"
            }}</mat-icon>
          </button>
        </div>

        <!-- ID -->
        <div class="col-id">
          <div class="cell cell-id">{{ r.id }}</div>
        </div>

        <!-- Cliente -->
        <div class="col-client">
          <div class="cell cell-client">
            {{ clientLabel(r) }}
          </div>
        </div>

        <!-- Nº facturas -->
        <div class="col-count">
          <div class="cell cell-count">{{ r.bills?.length ?? 0 }}</div>
        </div>

        <!-- Total adeudado -->
        <div class="col-total">
          <div class="cell cell-total">{{ fmtAmount(totalAmount(r)) }}</div>
        </div>

        <!-- Estado -->
        <div class="col-status">
          <div class="cell cell-status">
            <mat-chip [ngClass]="statusClass(r.status)">{{
              r.status
            }}</mat-chip>
          </div>
        </div>

        <!-- Acciones -->
        <div class="col-actions">
          <div class="cell cell-actions">
            <button mat-raised-button color="primary" (click)="approve(r)">
              Anticipar
            </button>
            <button mat-button color="warn" (click)="reject(r)">
              Cancelar
            </button>
          </div>
        </div>
      </div>

      <!-- Detalle expandido -->
      <div class="request-detail" *ngIf="isExpanded(r.id)">
        <div class="detail-header">
          <div class="detail-title">
            Facturas de la solicitud #{{ r.id }}
            <span class="muted"
              >({{ r.bills.length }} factura{{
                r.bills.length === 1 ? "" : "s"
              }})</span
            >
          </div>

          <!-- Info de cliente en detalle -->
          <div class="client-badge" *ngIf="r.user">
            <mat-icon>business</mat-icon>
            <div class="info">
              <div class="name">
                {{ r.user.companyName || r.user.name || "Cliente" }}
              </div>
              <div class="email" *ngIf="r.user.email">{{ r.user.email }}</div>
            </div>
          </div>
        </div>

        <table mat-table [dataSource]="r.bills" class="detail-table">
          <ng-container matColumnDef="invoiceNumber">
            <th mat-header-cell *matHeaderCellDef>Nº</th>
            <td mat-cell *matCellDef="let b">{{ b.invoiceNumber }}</td>
          </ng-container>

          <ng-container matColumnDef="debtor">
            <th mat-header-cell *matHeaderCellDef>Deudor</th>
            <td mat-cell *matCellDef="let b">{{ b.debtor?.companyName }}</td>
          </ng-container>

          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef>Importe</th>
            <td mat-cell *matCellDef="let b">{{ fmtBillAmount(b.amount) }}</td>
          </ng-container>

          <tr
            mat-header-row
            *matHeaderRowDef="['invoiceNumber', 'debtor', 'amount']"
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: ['invoiceNumber', 'debtor', 'amount']"
          ></tr>
        </table>
      </div>
    </ng-container>
  </div>
</mat-card>

<ng-template #loadingTpl>
  <div style="padding: 24px">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  </div>
</ng-template>
