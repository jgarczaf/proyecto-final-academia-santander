<h2>Solicitudes</h2>

<div class="filter-toolbar">
  <input
    type="text"
    placeholder="Buscar por empresa"
    [(ngModel)]="searchQuery"
    class="search-input"
  />
  <mat-select
    [(ngModel)]="selectedStatus"
    placeholder="Filtrar por estado"
    class="status-select"
  >
    <mat-option [value]="null">Todos</mat-option>
    <mat-option value="REVIEW">Pendiente</mat-option>
    <mat-option value="APPROVED">Validadas</mat-option>
    <mat-option value="REJECTED">Rechazadas</mat-option>
  </mat-select>
  <ath-button color="primary" size="md" fill="solid" (click)="applyFilters()">
    Buscar
  </ath-button>
</div>

<div class="toolbar">
  <span class="spacer"></span>
  <ath-button
    color="warn"
    size="md"
    fill="outlined"
    (click)="rejectSelected()"
    [disabled]="!hasSelectedRows()"
  >
    Rechazar
  </ath-button>
  <ath-button
    color="primary"
    size="md"
    fill="solid"
    (click)="approveSelected()"
    [disabled]="!hasSelectedRows()"
  >
    Anticipar
  </ath-button>
</div>

<mat-card class="list-card" *ngIf="!loading; else loadingTpl">
  <div class="table-wrap">
    <div class="header-row">
      <div class="col-expand">
        <mat-checkbox
          [checked]="isAllCurrentPageSelected()"
          [indeterminate]="isCurrentPageIndeterminate()"
          (change)="toggleSelectAllCurrentPage($event)"
        ></mat-checkbox>
      </div>
      <div class="col-status">
        <div class="cell cell-status cell-sortable" (click)="onSort('status')">
          <span>Estado</span>
          <mat-icon class="sort-icon">{{ getSortIcon("status") }}</mat-icon>
        </div>
      </div>
      <div class="col-debtor">
        <div class="cell cell-debtor cell-sortable" (click)="onSort('debtor')">
          <span>Deudor</span>
          <mat-icon class="sort-icon">{{ getSortIcon("debtor") }}</mat-icon>
        </div>
      </div>
      <div class="col-invoice">
        <div
          class="cell cell-invoice cell-sortable"
          (click)="onSort('invoice')"
        >
          <span>Ref. Factura</span>
          <mat-icon class="sort-icon">{{ getSortIcon("invoice") }}</mat-icon>
        </div>
      </div>
      <div class="col-amount">
        <div class="cell cell-amount cell-sortable" (click)="onSort('amount')">
          <span>Importe</span>
          <mat-icon class="sort-icon">{{ getSortIcon("amount") }}</mat-icon>
        </div>
      </div>
      <div class="col-issue-date">
        <div
          class="cell cell-issue-date cell-sortable"
          (click)="onSort('issueDate')"
        >
          <span>Fecha expedici√≥n</span>
          <mat-icon class="sort-icon">{{ getSortIcon("issueDate") }}</mat-icon>
        </div>
      </div>
      <div class="col-due-date">
        <div
          class="cell cell-due-date cell-sortable"
          (click)="onSort('dueDate')"
        >
          <span>Fecha vencimiento</span>
          <mat-icon class="sort-icon">{{ getSortIcon("dueDate") }}</mat-icon>
        </div>
      </div>
      <div class="col-actions">
        <div class="cell cell-actions">Acciones</div>
      </div>
    </div>

    <ng-container *ngFor="let r of paginatedRows">
      <div class="data-row">
        <div class="col-expand">
          <mat-checkbox
            [(ngModel)]="r.selected"
            [disabled]="!canSelectRow(r)"
            [checked]="r.selected || !canSelectRow(r)"
            (change)="onCheckboxChange(r)"
          ></mat-checkbox>
        </div>
        <div class="col-status">
          <div class="cell cell-status">
            <mat-chip [ngClass]="statusClass(r.status)">{{
              statusLabel(r.status)
            }}</mat-chip>
          </div>
        </div>
        <div class="col-debtor">
          <div class="cell cell-debtor">{{ getFirstBillDebtor(r) }}</div>
        </div>
        <div class="col-invoice">
          <div class="cell cell-invoice">{{ getFirstInvoiceNumber(r) }}</div>
        </div>
        <div class="col-amount">
          <div class="cell cell-amount">{{ getFirstBillAmount(r) }}</div>
        </div>
        <div class="col-issue-date">
          <div class="cell cell-issue-date">{{ getFirstIssueDate(r) }}</div>
        </div>
        <div class="col-due-date">
          <div class="cell cell-due-date">{{ getFirstDueDate(r) }}</div>
        </div>
        <div class="col-actions">
          <div class="cell cell-actions">
            <ath-button
              color="primary"
              size="xs"
              fill="outlined"
              (click)="openBillDetail(r)"
            >
              Ver Detalle
            </ath-button>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <div class="list-footer">
    <div class="selection-info">
      <strong
        >HAS SELECCIONADO {{ getTotalSelectedCount() }} SOLICITUD{{
          getTotalSelectedCount() === 1 ? "" : "ES"
        }}</strong
      >
    </div>
    <mat-paginator
      [length]="rows.length"
      [pageSize]="pageSize"
      [pageSizeOptions]="[5, 10]"
      [pageIndex]="pageIndex"
      (page)="onPageChange($event)"
      showFirstLastButtons
    ></mat-paginator>
  </div>
</mat-card>

<ng-template #loadingTpl>
  <div style="padding: 24px">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  </div>
</ng-template>
