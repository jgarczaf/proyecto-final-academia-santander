<ng-container *ngFor="let g of groups">
  <!-- Bloque informativo de empresa cedente -->
  <div class="cedente-block">
    <div class="cedente-label">Empresa cedente</div>
    <div class="cedente-value">
      {{ g.user?.companyName || "Desconocida" }}
      <span class="cedente-fiscal" *ngIf="g.user?.fiscalId">
        â€” {{ g.user?.fiscalId }}
      </span>
    </div>
  </div>

  <!-- Toolbar por grupo (filtros + acciones) -->
  <div class="search-label">Buscar por deudor</div>

  <div class="toolbar">
    <div class="filter-toolbar">
      <ath-input-text
        #searchRef
        name="search-debtor-bar"
        icon-position="left"
        type="search"
        placeholder="Escribe un nombre, DNI o razÃ³n social"
        [value]="g.searchQuery"
        (athClear)="onSearchClear(g, searchRef)"
        (keyup.enter)="applySearch(searchRef.value, g)"
        class="search-debtor-bar"
      ></ath-input-text>

      <ath-button
        color="secondary"
        size="md"
        fill="solid"
        (click)="applySearch(searchRef.value, g)"
        class="search-button"
      >
        Buscar
      </ath-button>

      <!-- ðŸ”¥ FILTRO INSTANTÃNEO AL CAMBIAR ESTADO -->
      <mat-select
        [(ngModel)]="g.selectedStatus"
        placeholder="Filtrar por estado"
        class="status-select"
        (selectionChange)="onStatusChange(g)"
      >
        <mat-option [value]="null">Todos</mat-option>
        <mat-option value="REVIEW">Pendiente</mat-option>
        <mat-option value="APPROVED">Validadas</mat-option>
        <mat-option value="REJECTED">Rechazadas</mat-option>
      </mat-select>
    </div>

    <span class="spacer"></span>

    <div class="buttons-toolbar">
      <ath-button
        color="warn"
        size="md"
        fill="outlined"
        (click)="rejectSelectedGroup(g)"
        [disabled]="!hasSelectedRowsGroup(g)"
      >
        Rechazar
      </ath-button>

      <ath-button
        color="primary"
        size="md"
        fill="solid"
        (click)="openAthModal(anticiparModal)"
        [disabled]="!hasSelectedRowsGroup(g)"
      >
        Anticipar
      </ath-button>

      <ath-modal
        #anticiparModal
        has-close="true"
        has-divider="true"
        close-aria-label="Cerrar"
      >
        <div slot="body">
          <ath-pictogram size="2xl" name="picto_illu_info_msg"></ath-pictogram>

          <div
            class="ath-body--sm ath-color-text--default"
            style="padding: 4px"
          >
            <h2>
              La selecciÃ³n supera los parÃ¡metros de importe o vencimiento
              permitidos.
            </h2>
            <h3>Â¿Desea continuar?</h3>
          </div>
        </div>

        <div
          slot="footer"
          style="display: flex; justify-content: center; gap: 8px"
        >
          <ath-button
            (click)="closeAthModal(anticiparModal)"
            aria-label="cancelar"
          >
            Cancelar
          </ath-button>

          <ath-button
            color="secondary"
            (click)="confirmAnticipar(g, anticiparModal)"
            aria-label="anticipar"
          >
            Anticipar
          </ath-button>
        </div>
      </ath-modal>
    </div>
  </div>

  <!-- Tabla por grupo -->
  <mat-card class="list-card" *ngIf="!loading; else loadingTpl">
    <div class="table-wrap">
      <div class="header-row">
        <div class="col-expand">
          <input
            type="checkbox"
            class="n-chk"
            [checked]="isAllCurrentPageSelectedGroup(g)"
            [indeterminate]="isCurrentPageIndeterminateGroup(g)"
            (change)="
              toggleSelectAllCurrentPageGroup(g, $any($event.target).checked)
            "
            aria-label="Seleccionar todo"
          />
        </div>

        <div class="col-status">
          <div
            class="cell cell-status cell-sortable"
            (click)="onSortGroup(g, 'status')"
          >
            <span>Estado</span>
            <mat-icon class="sort-icon">
              {{ getSortIconGroup(g, "status") }}
            </mat-icon>
          </div>
        </div>

        <div class="col-debtor">
          <div
            class="cell cell-debtor cell-sortable"
            (click)="onSortGroup(g, 'debtor')"
          >
            <span>Deudor</span>
            <mat-icon class="sort-icon">
              {{ getSortIconGroup(g, "debtor") }}
            </mat-icon>
          </div>
        </div>

        <div class="col-invoice">
          <div
            class="cell cell-invoice cell-sortable"
            (click)="onSortGroup(g, 'invoice')"
          >
            <span>Ref. Factura</span>
            <mat-icon class="sort-icon">
              {{ getSortIconGroup(g, "invoice") }}
            </mat-icon>
          </div>
        </div>

        <div class="col-amount">
          <div
            class="cell cell-amount cell-sortable"
            (click)="onSortGroup(g, 'amount')"
          >
            <span>Importe</span>
            <mat-icon class="sort-icon">
              {{ getSortIconGroup(g, "amount") }}
            </mat-icon>
          </div>
        </div>

        <div class="col-issue-date">
          <div
            class="cell cell-issue-date cell-sortable"
            (click)="onSortGroup(g, 'issueDate')"
          >
            <span>Fecha expediciÃ³n</span>
            <mat-icon class="sort-icon">
              {{ getSortIconGroup(g, "issueDate") }}
            </mat-icon>
          </div>
        </div>

        <div class="col-due-date">
          <div
            class="cell cell-due-date cell-sortable"
            (click)="onSortGroup(g, 'dueDate')"
          >
            <span>Fecha vencimiento</span>
            <mat-icon class="sort-icon">
              {{ getSortIconGroup(g, "dueDate") }}
            </mat-icon>
          </div>
        </div>

        <div class="col-actions">
          <div class="cell cell-actions">Acciones</div>
        </div>
      </div>

      <ng-container *ngFor="let r of g.paginated">
        <div class="data-row">
          <div class="col-expand">
            <input
              type="checkbox"
              class="n-chk"
              [checked]="r.selected || !canSelectRow(r)"
              [disabled]="!canSelectRow(r)"
              (change)="
                r.selected = $any($event.target).checked; onCheckboxChange(r)
              "
              aria-label="Seleccionar fila"
            />
          </div>

          <div class="col-status">
            <div class="cell cell-status">
              <mat-chip [ngClass]="statusClass(r.status)">
                {{ statusLabel(r.status) }}
              </mat-chip>
            </div>
          </div>

          <div class="col-debtor">
            <div class="cell cell-debtor">{{ getFirstBillDebtor(r) }}</div>
          </div>

          <div class="col-invoice">
            <div class="cell cell-invoice">{{ getFirstInvoiceNumber(r) }}</div>
          </div>

          <div class="col-amount">
            <div class="cell cell-amount">{{ getFirstBillAmount(r) }}</div>
          </div>

          <div class="col-issue-date">
            <div class="cell cell-issue-date">{{ getFirstIssueDate(r) }}</div>
          </div>

          <div class="col-due-date">
            <div class="cell cell-due-date">{{ getFirstDueDate(r) }}</div>
          </div>

          <div class="col-actions">
            <div class="cell cell-actions">
              <ath-button
                color="secondary"
                size="xs"
                fill="outlined"
                (click)="openBillDetail(r)"
              >
                Ver factura
              </ath-button>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- FOOTER -->
    <div class="list-footer">
      <div class="selection-info">
        <div class="story__item">
          <ath-alert type="page" color="info" has-close="false">
            Has seleccionado {{ getTotalSelectedCountGroup(g) }} solicitud{{
              getTotalSelectedCountGroup(g) === 1 ? "" : "es"
            }}
          </ath-alert>
        </div>
      </div>

      <mat-paginator
        [length]="g.filtered.length"
        [pageSize]="g.pageSize"
        [pageSizeOptions]="[5, 10]"
        [pageIndex]="g.pageIndex"
        (page)="onPageChangeGroup(g, $event)"
        showFirstLastButtons
      ></mat-paginator>
    </div>
  </mat-card>
</ng-container>

<ng-template #loadingTpl>
  <div style="padding: 24px">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  </div>
</ng-template>
