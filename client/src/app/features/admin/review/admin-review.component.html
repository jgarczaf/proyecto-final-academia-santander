<h2>Solicitudes</h2>

<!-- ===== TABS DE FILTRADO ===== -->
<mat-tab-group (selectedIndexChange)="onTabChange(statusTabs[$event].value)">
  <mat-tab *ngFor="let tab of statusTabs; let i = index" [label]="tab.label">
  </mat-tab>
</mat-tab-group>

<div class="toolbar">
  <div class="selection-info" *ngIf="getTotalSelectedCount() > 0">
    <strong
      >HAS SELECCIONADO {{ getTotalSelectedCount() }} SOLICITUD{{
        getTotalSelectedCount() === 1 ? "" : "ES"
      }}</strong
    >
  </div>
  <span class="spacer"></span>
  <ath-button
    color="primary"
    size="md"
    fill="solid"
    (click)="approveSelected()"
    [disabled]="!hasSelectedRows()"
  >
    Anticipar Seleccionadas
  </ath-button>
  <ath-button
    color="warn"
    size="md"
    fill="outlined"
    (click)="rejectSelected()"
    [disabled]="!hasSelectedRows()"
  >
    Cancelar Seleccionadas
  </ath-button>
</div>

<mat-card class="list-card" *ngIf="!loading; else loadingTpl">
  <div class="table-wrap">
    <!-- ===== HEADER (grid) CON ORDENACIÓN ===== -->
    <div class="header-row">
      <div class="col-expand">
        <mat-checkbox
          [checked]="isAllCurrentPageSelected()"
          [indeterminate]="isCurrentPageIndeterminate()"
          (change)="toggleSelectAllCurrentPage($event)"
        ></mat-checkbox>
      </div>
      <div class="col-id">
        <div class="cell cell-id cell-sortable" (click)="onSort('id')">
          ID solicitud
          <mat-icon class="sort-icon">{{ getSortIcon("id") }}</mat-icon>
        </div>
      </div>
      <div class="col-client">
        <div class="cell cell-client cell-sortable" (click)="onSort('client')">
          Cliente
          <mat-icon class="sort-icon">{{ getSortIcon("client") }}</mat-icon>
        </div>
      </div>
      <div class="col-count">
        <div class="cell cell-count cell-sortable" (click)="onSort('bills')">
          Nº facturas
          <mat-icon class="sort-icon">{{ getSortIcon("bills") }}</mat-icon>
        </div>
      </div>
      <div class="col-total">
        <div class="cell cell-total cell-sortable" (click)="onSort('total')">
          Total adeudado
          <mat-icon class="sort-icon">{{ getSortIcon("total") }}</mat-icon>
        </div>
      </div>
      <div class="col-status">
        <div class="cell cell-status cell-sortable" (click)="onSort('status')">
          Estado
          <mat-icon class="sort-icon">{{ getSortIcon("status") }}</mat-icon>
        </div>
      </div>
      <div class="col-actions">
        <div class="cell cell-actions">Acciones</div>
      </div>
    </div>

    <!-- ===== FILAS ===== -->
    <ng-container *ngFor="let r of paginatedRows">
      <!-- Fila principal -->
      <div class="data-row">
        <!-- Checkbox -->
        <div class="col-expand">
          <mat-checkbox
            [(ngModel)]="r.selected"
            (change)="onCheckboxChange(r)"
          ></mat-checkbox>
        </div>

        <!-- ID -->
        <div class="col-id">
          <div class="cell cell-id">{{ r.id }}</div>
        </div>

        <!-- Cliente -->
        <div class="col-client">
          <div class="cell cell-client">
            {{ clientLabel(r) }}
          </div>
        </div>

        <!-- Nº facturas -->
        <div class="col-count">
          <div class="cell cell-count">{{ r.bills.length }}</div>
        </div>

        <!-- Total adeudado -->
        <div class="col-total">
          <div class="cell cell-total">{{ fmtAmount(totalAmount(r)) }}</div>
        </div>

        <!-- Estado -->
        <div class="col-status">
          <div class="cell cell-status">
            <mat-chip [ngClass]="statusClass(r.status)">{{
              statusLabel(r.status)
            }}</mat-chip>
          </div>
        </div>

        <!-- Acciones -->
        <div class="col-actions">
          <div class="cell cell-actions">
            <ath-button
              color="primary"
              size="xs"
              fill="outlined"
              (click)="openBillDetail(r)"
            >
              Ver Detalle
            </ath-button>
          </div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- ===== PAGINADOR ===== -->
  <mat-paginator
    [length]="rows.length"
    [pageSize]="pageSize"
    [pageSizeOptions]="[10, 25, 50]"
    [pageIndex]="pageIndex"
    (page)="onPageChange($event)"
    showFirstLastButtons
  ></mat-paginator>
</mat-card>

<ng-template #loadingTpl>
  <div style="padding: 24px">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  </div>
</ng-template>
