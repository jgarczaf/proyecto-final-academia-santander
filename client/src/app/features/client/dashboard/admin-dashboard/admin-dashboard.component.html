<div *ngIf="loading" style="padding: 24px">
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
</div>

<!-- ===== Dashboard ===== -->
<div *ngIf="!loading && data as d" class="admin-dash">
  <!-- ===== KPIs ===== -->
  <section class="kpis">
    <mat-card class="kpi">
      <div class="kpi-header">
        <mat-icon>business</mat-icon>
        <mat-card-title>Clientes</mat-card-title>
      </div>
      <mat-card-content>
        <div class="kpi-value">{{ d.totals.clients }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi">
      <div class="kpi-header">
        <mat-icon>receipt</mat-icon>
        <mat-card-title>Facturas en revisión</mat-card-title>
      </div>
      <mat-card-content>
        <div class="kpi-value">{{ d.totals.billsInRequest }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi">
      <div class="kpi-header">
        <mat-icon>pending_actions</mat-icon>
        <mat-card-title>Solicitudes en revisión</mat-card-title>
      </div>
      <mat-card-content>
        <div class="kpi-value">{{ d.totals.requestsInReview }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="kpi highlight">
      <div class="kpi-header">
        <mat-icon>euro</mat-icon>
        <mat-card-title>Importe en revisión</mat-card-title>
      </div>
      <mat-card-content>
        <div class="kpi-value big">
          {{ fmtAmount(d.totals.amountInReview) }}
        </div>
      </mat-card-content>
    </mat-card>
  </section>

  <!-- ===== Últimas solicitudes ===== -->
  <section class="last-requests">
    <mat-card class="block">
      <mat-card-title>Últimas 3 solicitudes</mat-card-title>

      <div class="table-wrap">
        <table
          mat-table
          [dataSource]="getLastUpdatedRequests()"
          class="mat-elevation-z2"
        >
          <!-- ID -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let r">{{ r.id }}</td>
          </ng-container>

          <!-- Fecha -->
          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>Fecha</th>
            <td mat-cell *matCellDef="let r">{{ fmtDate(r.createdAt) }}</td>
          </ng-container>

          <!-- # Facturas -->
          <ng-container matColumnDef="bills">
            <th mat-header-cell *matHeaderCellDef># Facturas</th>
            <td mat-cell *matCellDef="let r">{{ r.bills.length }}</td>
          </ng-container>

          <!-- Total facturas -->
          <ng-container matColumnDef="total">
            <th mat-header-cell *matHeaderCellDef>Total</th>
            <td mat-cell *matCellDef="let r">{{ fmtAmount(totalOf(r)) }}</td>
          </ng-container>

          <!-- Estado -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let r">
              <mat-chip [ngClass]="statusClass(r.status)">{{
                statusLabel(r.status)
              }}</mat-chip>
            </td>
          </ng-container>

          <!-- Cliente -->
          <ng-container matColumnDef="client">
            <th mat-header-cell *matHeaderCellDef>Cliente</th>
            <td mat-cell *matCellDef="let r">
              {{ r.user?.companyName || r.user?.name || r.user?.email || "—" }}
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="reqsCols"></tr>
          <tr mat-row *matRowDef="let row; columns: reqsCols"></tr>
        </table>
      </div>
    </mat-card>
  </section>

  <!-- ===== Solicitudes en revisión ===== -->
  <section class="review-requests">
    <mat-card class="block">
      <mat-card-title>Facturas pendientes de revisión</mat-card-title>

      <div class="table-wrap">
        <table
          mat-table
          [dataSource]="getRequestsInReview()"
          class="mat-elevation-z2"
        >
          <!-- ID -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let r">{{ r.id }}</td>
          </ng-container>

          <!-- Cliente -->
          <ng-container matColumnDef="client">
            <th mat-header-cell *matHeaderCellDef>Cliente</th>
            <td mat-cell *matCellDef="let r">
              {{ r.user?.companyName || r.user?.name || r.user?.email || "—" }}
            </td>
          </ng-container>

          <!-- # Facturas -->
          <ng-container matColumnDef="bills">
            <th mat-header-cell *matHeaderCellDef># Facturas</th>
            <td mat-cell *matCellDef="let r">{{ r.bills.length }}</td>
          </ng-container>

          <!-- Total -->
          <ng-container matColumnDef="total">
            <th mat-header-cell *matHeaderCellDef>Total</th>
            <td mat-cell *matCellDef="let r">{{ fmtAmount(totalOf(r)) }}</td>
          </ng-container>

          <!-- Fecha -->
          <ng-container matColumnDef="createdAt">
            <th mat-header-cell *matHeaderCellDef>Fecha</th>
            <td mat-cell *matCellDef="let r">{{ fmtDate(r.createdAt) }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="reviewCols"></tr>
          <tr mat-row *matRowDef="let row; columns: reviewCols"></tr>
        </table>

        <div class="empty-state" *ngIf="getRequestsInReview().length === 0">
          <mat-icon>inbox</mat-icon>
          <p>Sin solicitudes pendientes de revisión</p>
        </div>
      </div>
    </mat-card>
  </section>
</div>
