<div class="toolbar">
  <h2>Solicitudes</h2>
  <span class="spacer"></span>

  <button
    mat-stroked-button
    color="primary"
    (click)="expandAll()"
    [disabled]="!hasRows()"
  >
    Expandir todo
  </button>

  <button mat-stroked-button (click)="collapseAll()" [disabled]="!hasRows()">
    Contraer todo
  </button>
</div>

<mat-card class="table-card">
  <div class="table-wrap">
    <!-- ===== HEADER ===== -->
    <div class="header-row">
      <div class="col-expand"></div>
      <div class="col-id">ID</div>
      <div class="col-count">Nº facturas</div>
      <div class="col-total">Total adeudado</div>
      <div class="col-status">Estado</div>
    </div>

    <!-- ===== FILAS ===== -->
    <ng-container *ngFor="let r of rows">
      <div class="data-row">
        <div class="col-expand">
          <button mat-icon-button (click)="toggleRow(r)">
            <mat-icon>
              {{ isExpanded(r.id) ? "expand_less" : "expand_more" }}
            </mat-icon>
          </button>
        </div>

        <div class="col-id">{{ r.id }}</div>

        <div class="col-count">
          {{ r.bills.length }}
        </div>

        <div class="col-total">
          {{ fmtAmount(totalAmount(r)) }}
        </div>

        <div class="col-status">
          <mat-chip>{{ r.status }}</mat-chip>
        </div>
      </div>

      <!-- ===== DETALLE ===== -->
      <div class="request-detail" *ngIf="isExpanded(r.id)">
        <h4>
          Facturas de la solicitud #{{ r.id }}
          <span class="muted">
            ({{ r.bills.length }} factura{{ r.bills.length === 1 ? "" : "s" }})
          </span>
        </h4>

        <table mat-table [dataSource]="r.bills" class="detail-table">
          <ng-container matColumnDef="invoiceNumber">
            <th mat-header-cell *matHeaderCellDef>Nº</th>
            <td mat-cell *matCellDef="let b">{{ b.invoiceNumber }}</td>
          </ng-container>

          <ng-container matColumnDef="debtor">
            <th mat-header-cell *matHeaderCellDef>Deudor</th>
            <td mat-cell *matCellDef="let b">{{ b.debtor?.companyName }}</td>
          </ng-container>

          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef>Importe</th>
            <td mat-cell *matCellDef="let b">{{ fmtBillAmount(b.amount) }}</td>
          </ng-container>

          <tr
            mat-header-row
            *matHeaderRowDef="['invoiceNumber', 'debtor', 'amount']"
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: ['invoiceNumber', 'debtor', 'amount']"
          ></tr>
        </table>
      </div>
    </ng-container>
  </div>
</mat-card>
